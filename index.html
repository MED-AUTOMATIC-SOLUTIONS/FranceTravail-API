<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Offres France Travail</title>
  <link rel="icon" href="logo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      max-width: 100vw;
      overflow-x: hidden;
    }
  </style>
</head>

<body class="bg-gray-900 text-white p-4 sm:p-8 dark">
  <h1 class="text-3xl font-bold mb-2 text-center">Offres d'emploi France Travail</h1>
  <div id="compteur" class="text-center text-gray-400 mb-6 text-sm"></div>
  <div id="offres" class="grid gap-4 max-w-4xl w-full mx-auto"></div>
  <div id="erreur" class="text-red-600 text-center mt-4"></div>

  <script>
    function tempsEcouleDepuis(dateString) {
      const date = new Date(dateString);
      const maintenant = new Date();
      const diffMs = maintenant - date;

      const secondes = Math.floor(diffMs / 1000);
      const minutes = Math.floor(secondes / 60);
      const heures = Math.floor(minutes / 60);
      const jours = Math.floor(heures / 24);
      const mois = Math.floor(jours / 30);
      const annees = Math.floor(jours / 365);

      if (annees >= 1) return `il y a ${annees} an${annees > 1 ? 's' : ''}`;
      if (mois >= 1) return `il y a ${mois} mois`;
      if (jours >= 1) return `il y a ${jours} jour${jours > 1 ? 's' : ''}`;
      if (heures >= 1) return `il y a ${heures} h`;
      if (minutes >= 1) return `il y a ${minutes} min`;
      return `à l’instant`;
    }

    async function chargerOffres() {
      const container = document.getElementById("offres");
      const erreur = document.getElementById("erreur");
      const compteur = document.getElementById("compteur");

      container.innerHTML = "<div class='text-center p-4 text-gray-400 animate-pulse'>Chargement des offres...</div>";

      try {
        const res = await fetch('https://francetravail-serveur.onrender.com/api/offres');
        const data = await res.json();

        if (!data.resultats || data.resultats.length === 0) {
          container.innerHTML = "<p class='text-center text-gray-500'>Aucune offre trouvée.</p>";
          compteur.textContent = '';
          return;
        }

        container.innerHTML = '';
        compteur.textContent = `${data.resultats.length} offre${data.resultats.length > 1 ? 's' : ''} trouvée${data.resultats.length > 1 ? 's' : ''}`;

        data.resultats.forEach(offre => {
          const div = document.createElement("div");
          div.className = "bg-gray-800 p-4 rounded shadow";
          div.innerHTML = ` 
            <h2 class="text-xl font-bold mb-2">${offre.intitule}</h2>
            <p><strong>Entreprise :</strong> ${offre.entreprise?.nom || "N/A"}</p>
            <p><strong>Lieu :</strong> ${offre.lieuTravail?.libelle || "N/A"}</p>
            <p class="text-gray-400 mt-2">${offre.description?.slice(0, 200) || "Pas de description"}...</p>
            <div class="flex justify-between items-center mt-4 text-sm text-gray-400">
              <span>${tempsEcouleDepuis(offre.dateActualisation)}</span>
              <a href="detail.html?id=${offre.id}" class="text-blue-400 underline">Détails de l'offre</a>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        erreur.textContent = "Erreur lors de la récupération des offres.";
        console.error(err);
      }
    }

    chargerOffres();
  </script>
</body>

</html>
